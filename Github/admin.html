{% extends "base.html" %}

{% block title %}Admin Panel - Cash IT{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1><i class="fas fa-cog"></i> Admin Panel</h1>
                        <p class="text-muted mb-0">System administration and user management</p>
                    </div>
                    <div class="admin-badge">
                        <span class="badge bg-danger">
                            <i class="fas fa-shield-alt"></i> Administrator
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Overview -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="admin-metric-card users">
                <div class="metric-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="metric-info">
                    <h3>{{ stats.total_users }}</h3>
                    <p>Total Users</p>
                    <span class="metric-change positive">+{{ stats.active_users }}</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-metric-card transactions">
                <div class="metric-icon">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <div class="metric-info">
                    <h3>{{ "{:,}".format(stats.total_transactions) }}</h3>
                    <p>Total Transactions</p>
                    <span class="metric-change positive">Active</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-metric-card balance">
                <div class="metric-icon">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="metric-info">
                    <h3>${{ "{:,.2f}".format(stats.total_balance) }}</h3>
                    <p>Total Balance</p>
                    <span class="metric-change positive">Secured</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-metric-card system">
                <div class="metric-icon">
                    <i class="fas fa-server"></i>
                </div>
                <div class="metric-info">
                    <h3>99.9%</h3>
                    <p>System Uptime</p>
                    <span class="metric-change positive">Operational</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Admin Content -->
        <div class="col-lg-8">
            <!-- User Management -->
            <div class="glass-card p-4 mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="fas fa-users-cog"></i> User Management</h5>
                    <div class="admin-controls">
                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">
                            <i class="fas fa-user-plus"></i> Add User
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="refreshUserList()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>
                
                <!-- User Search and Filters -->
                <div class="admin-filters mb-3">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="userSearch" placeholder="Search users by name or email...">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="userStatusFilter">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="userSortBy">
                                <option value="created_at">Sort by Registration Date</option>
                                <option value="name">Sort by Name</option>
                                <option value="balance">Sort by Balance</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Accounts</th>
                                <th>Total Balance</th>
                                <th>Joined</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Users will be populated here -->
                            <tr>
                                <td>
                                    <div class="user-info">
                                        <div class="user-avatar">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div>
                                            <div class="user-name">John Demo</div>
                                            <div class="user-email">demo@cashit.com</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-info">3 accounts</span>
                                </td>
                                <td>
                                    <span class="balance-amount">$20,250.25</span>
                                </td>
                                <td>
                                    <span class="join-date">2024-01-01</span>
                                </td>
                                <td>
                                    <span class="status-badge active">Active</span>
                                </td>
                                <td>
                                    <div class="admin-actions">
                                        <button class="btn btn-outline-primary btn-sm" onclick="viewUser('demo@cashit.com')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm" onclick="editUser('demo@cashit.com')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="suspendUser('demo@cashit.com')">
                                            <i class="fas fa-ban"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="showing-info">
                        Showing 1-10 of {{ stats.total_users }} users
                    </div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item disabled">
                                <span class="page-link">Previous</span>
                            </li>
                            <li class="page-item active">
                                <span class="page-link">1</span>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">2</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>

            <!-- System Logs -->
            <div class="glass-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="fas fa-list-alt"></i> System Activity Logs</h5>
                    <div class="log-controls">
                        <select class="form-select form-select-sm" id="logLevel">
                            <option value="">All Levels</option>
                            <option value="info">Info</option>
                            <option value="warning">Warning</option>
                            <option value="error">Error</option>
                        </select>
                    </div>
                </div>

                <div class="system-logs">
                    <div class="log-item info">
                        <div class="log-timestamp">2024-08-14 10:30:15</div>
                        <div class="log-level info">INFO</div>
                        <div class="log-message">User demo@cashit.com logged in successfully</div>
                    </div>
                    <div class="log-item warning">
                        <div class="log-timestamp">2024-08-14 10:28:42</div>
                        <div class="log-level warning">WARN</div>
                        <div class="log-message">Failed login attempt from IP 192.168.1.45</div>
                    </div>
                    <div class="log-item info">
                        <div class="log-timestamp">2024-08-14 10:25:33</div>
                        <div class="log-level info">INFO</div>
                        <div class="log-message">New transaction processed for user demo@cashit.com</div>
                    </div>
                    <div class="log-item error">
                        <div class="log-timestamp">2024-08-14 10:20:18</div>
                        <div class="log-level error">ERROR</div>
                        <div class="log-message">Database connection timeout - recovered automatically</div>
                    </div>
                </div>

                <div class="text-center mt-3">
                    <button class="btn btn-outline-secondary btn-sm" onclick="loadMoreLogs()">
                        <i class="fas fa-chevron-down"></i> Load More Logs
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="glass-card p-4 mb-4">
                <h6><i class="fas fa-bolt"></i> Quick Actions</h6>
                
                <div class="quick-admin-actions">
                    <button class="action-btn backup" onclick="initiateBackup()">
                        <i class="fas fa-database"></i>
                        <div>
                            <span class="action-title">Backup Data</span>
                            <span class="action-desc">Create system backup</span>
                        </div>
                    </button>
                    
                    <button class="action-btn maintenance" onclick="toggleMaintenance()">
                        <i class="fas fa-tools"></i>
                        <div>
                            <span class="action-title">Maintenance Mode</span>
                            <span class="action-desc">Enable/disable maintenance</span>
                        </div>
                    </button>
                    
                    <button class="action-btn export" onclick="exportData()">
                        <i class="fas fa-download"></i>
                        <div>
                            <span class="action-title">Export Reports</span>
                            <span class="action-desc">Generate system reports</span>
                        </div>
                    </button>
                    
                    <button class="action-btn security" onclick="securityScan()">
                        <i class="fas fa-shield-alt"></i>
                        <div>
                            <span class="action-title">Security Scan</span>
                            <span class="action-desc">Run security analysis</span>
                        </div>
                    </button>
                </div>
            </div>

            <!-- System Health -->
            <div class="glass-card p-4 mb-4">
                <h6><i class="fas fa-heartbeat"></i> System Health</h6>
                
                <div class="health-metrics">
                    <div class="health-item">
                        <div class="health-label">CPU Usage</div>
                        <div class="health-bar">
                            <div class="health-fill" style="width: 35%; background: #27ae60;"></div>
                        </div>
                        <div class="health-value">35%</div>
                    </div>
                    
                    <div class="health-item">
                        <div class="health-label">Memory Usage</div>
                        <div class="health-bar">
                            <div class="health-fill" style="width: 62%; background: #f39c12;"></div>
                        </div>
                        <div class="health-value">62%</div>
                    </div>
                    
                    <div class="health-item">
                        <div class="health-label">Disk Usage</div>
                        <div class="health-bar">
                            <div class="health-fill" style="width: 28%; background: #27ae60;"></div>
                        </div>
                        <div class="health-value">28%</div>
                    </div>
                    
                    <div class="health-item">
                        <div class="health-label">Network I/O</div>
                        <div class="health-bar">
                            <div class="health-fill" style="width: 45%; background: #3498db;"></div>
                        </div>
                        <div class="health-value">45 MB/s</div>
                    </div>
                </div>
            </div>

            <!-- Security Alerts -->
            <div class="glass-card p-4">
                <h6><i class="fas fa-exclamation-triangle"></i> Security Alerts</h6>
                
                <div class="security-alerts">
                    <div class="alert-item medium">
                        <div class="alert-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="alert-content">
                            <div class="alert-title">Suspicious Login Activity</div>
                            <div class="alert-desc">3 failed login attempts detected</div>
                            <div class="alert-time">5 minutes ago</div>
                        </div>
                    </div>
                    
                    <div class="alert-item low">
                        <div class="alert-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="alert-content">
                            <div class="alert-title">System Update Available</div>
                            <div class="alert-desc">Security patch v2.1.3 ready</div>
                            <div class="alert-time">2 hours ago</div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <a href="{{ url_for('security') }}" class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-shield-alt"></i> View All Alerts
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-plus"></i> Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addUserForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Initial Password</label>
                            <input type="password" class="form-control" name="password" required minlength="8">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">User Role</label>
                            <select class="form-select" name="role" required>
                                <option value="">Select role...</option>
                                <option value="user">Regular User</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="send_welcome" id="sendWelcome" checked>
                                <label class="form-check-label" for="sendWelcome">
                                    Send welcome email with login instructions
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> Create User
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Admin panel functionality
function refreshUserList() {
    CashIT.showNotification('Refreshing user list...', 'info', 2000);
    // In a real implementation, this would reload the user data
    setTimeout(() => {
        CashIT.showNotification('User list refreshed successfully', 'success');
    }, 1000);
}

function viewUser(email) {
    // Redirect to user detail view or open modal
    CashIT.showNotification(`Viewing user: ${email}`, 'info');
}

function editUser(email) {
    CashIT.showNotification(`Edit user feature for ${email} coming soon!`, 'info');
}

function suspendUser(email) {
    if (confirm(`Are you sure you want to suspend user ${email}?`)) {
        CashIT.showNotification(`User ${email} suspended successfully`, 'warning');
    }
}

function initiateBackup() {
    if (confirm('Are you sure you want to create a system backup? This may take several minutes.')) {
        CashIT.showNotification('Backup initiated. You will be notified when complete.', 'info');
        // Simulate backup progress
        setTimeout(() => {
            CashIT.showNotification('System backup completed successfully', 'success');
        }, 5000);
    }
}

function toggleMaintenance() {
    const isEnabled = confirm('Toggle maintenance mode? This will affect all users.');
    if (isEnabled) {
        CashIT.showNotification('Maintenance mode toggled', 'warning');
    }
}

function exportData() {
    CashIT.showNotification('Generating system reports...', 'info');
    setTimeout(() => {
        CashIT.showNotification('Reports generated successfully', 'success');
    }, 3000);
}

function securityScan() {
    CashIT.showNotification('Security scan initiated...', 'info');
    setTimeout(() => {
        CashIT.showNotification('Security scan completed - No threats detected', 'success');
    }, 4000);
}

function loadMoreLogs() {
    CashIT.showNotification('Loading more logs...', 'info', 1000);
}

// User search functionality
document.getElementById('userSearch').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    // Filter user table rows based on search term
    // Implementation would filter the actual user data
});

// Filter functionality
document.getElementById('userStatusFilter').addEventListener('change', function() {
    const status = this.value;
    CashIT.showNotification(`Filtering by status: ${status || 'All'}`, 'info', 1000);
});

document.getElementById('userSortBy').addEventListener('change', function() {
    const sortBy = this.value;
    CashIT.showNotification(`Sorting by: ${sortBy}`, 'info', 1000);
});

// Log level filter
document.getElementById('logLevel').addEventListener('change', function() {
    const level = this.value;
    const logItems = document.querySelectorAll('.log-item');
    
    logItems.forEach(item => {
        if (!level || item.classList.contains(level)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
});

// Add user form submission
document.getElementById('addUserForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const userData = Object.fromEntries(formData);
    
    // Validate form
    if (!CashIT.validateEmail(userData.email)) {
        CashIT.showNotification('Please enter a valid email address', 'error');
        return;
    }
    
    if (!CashIT.validatePassword(userData.password)) {
        CashIT.showNotification('Password must be at least 8 characters with mixed case, numbers, and symbols', 'error');
        return;
    }
    
    // Submit form
    CashIT.showNotification('Creating user account...', 'info');
    
    setTimeout(() => {
        CashIT.showNotification(`User account created successfully for ${userData.email}`, 'success');
        bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
        this.reset();
        refreshUserList();
    }, 2000);
});

// Real-time updates for system health metrics
setInterval(() => {
    document.querySelectorAll('.health-fill').forEach(fill => {
        const currentWidth = parseInt(fill.style.width);
        const variation = Math.random() * 10 - 5; // Â±5% variation
        const newWidth = Math.max(0, Math.min(100, currentWidth + variation));
        fill.style.width = newWidth + '%';
        
        // Update color based on usage
        if (newWidth > 80) {
            fill.style.background = '#e74c3c';
        } else if (newWidth > 60) {
            fill.style.background = '#f39c12';
        } else {
            fill.style.background = '#27ae60';
        }
    });
}, 5000);
</script>

<style>
.admin-badge .badge {
    font-size: 0.9rem;
    padding: 0.5rem 1rem;
}

.admin-metric-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.admin-metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.metric-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    margin-right: 1rem;
}

.admin-metric-card.users .metric-icon {
    background: linear-gradient(45deg, #3498db, #2980b9);
}

.admin-metric-card.transactions .metric-icon {
    background: linear-gradient(45deg, #e67e22, #d35400);
}

.admin-metric-card.balance .metric-icon {
    background: linear-gradient(45deg, #27ae60, #229954);
}

.admin-metric-card.system .metric-icon {
    background: linear-gradient(45deg, #9b59b6, #8e44ad);
}

.admin-filters {
    background: rgba(255,255,255,0.5);
    border-radius: 10px;
    padding: 1rem;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(45deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.user-name {
    font-weight: 600;
    color: #2c3e50;
}

.user-email {
    font-size: 0.85rem;
    color: #7f8c8d;
}

.balance-amount {
    font-weight: bold;
    color: #27ae60;
}

.status-badge {
    padding: 0.2rem 0.8rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-badge.active {
    background: rgba(39, 174, 96, 0.1);
    color: #27ae60;
}

.admin-actions {
    display: flex;
    gap: 0.3rem;
}

.system-logs {
    max-height: 400px;
    overflow-y: auto;
}

.log-item {
    display: flex;
    align-items: center;
    padding: 0.8rem;
    border-bottom: 1px solid rgba(0,0,0,0.1);
    gap: 1rem;
}

.log-timestamp {
    font-size: 0.8rem;
    color: #7f8c8d;
    min-width: 130px;
}

.log-level {
    padding: 0.2rem 0.6rem;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 600;
    min-width: 60px;
    text-align: center;
}

.log-level.info {
    background: rgba(52, 152, 219, 0.1);
    color: #3498db;
}

.log-level.warning {
    background: rgba(243, 156, 18, 0.1);
    color: #f39c12;
}

.log-level.error {
    background: rgba(231, 76, 60, 0.1);
    color: #e74c3c;
}

.log-message {
    flex: 1;
    font-size: 0.9rem;
    color: #2c3e50;
}

.quick-admin-actions {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.action-btn {
    display: flex;
    align-items: center;
    padding: 1rem;
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 10px;
    background: rgba(255,255,255,0.5);
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: left;
    width: 100%;
}

.action-btn:hover {
    background: rgba(255,255,255,0.8);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.action-btn i {
    font-size: 1.5rem;
    margin-right: 1rem;
    width: 30px;
    text-align: center;
}

.action-btn.backup i { color: #3498db; }
.action-btn.maintenance i { color: #f39c12; }
.action-btn.export i { color: #27ae60; }
.action-btn.security i { color: #e74c3c; }

.action-title {
    display: block;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.2rem;
}

.action-desc {
    display: block;
    font-size: 0.8rem;
    color: #7f8c8d;
}

.health-metrics {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.health-item {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.health-label {
    min-width: 80px;
    font-size: 0.9rem;
    color: #2c3e50;
    font-weight: 500;
}

.health-bar {
    flex: 1;
    height: 8px;
    background: rgba(0,0,0,0.1);
    border-radius: 4px;
    overflow: hidden;
}

.health-fill {
    height: 100%;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.health-value {
    min-width: 50px;
    text-align: right;
    font-size: 0.9rem;
    font-weight: 600;
    color: #2c3e50;
}

.security-alerts {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.alert-item {
    display: flex;
    align-items: flex-start;
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid;
}

.alert-item.high {
    background: rgba(231, 76, 60, 0.05);
    border-left-color: #e74c3c;
}

.alert-item.medium {
    background: rgba(243, 156, 18, 0.05);
    border-left-color: #f39c12;
}

.alert-item.low {
    background: rgba(52, 152, 219, 0.05);
    border-left-color: #3498db;
}

.alert-icon {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    margin-right: 1rem;
    flex-shrink: 0;
}

.alert-item.high .alert-icon { background: #e74c3c; }
.alert-item.medium .alert-icon { background: #f39c12; }
.alert-item.low .alert-icon { background: #3498db; }

.alert-title {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.2rem;
    font-size: 0.9rem;
}

.alert-desc {
    color: #7f8c8d;
    font-size: 0.8rem;
    margin-bottom: 0.3rem;
}

.alert-time {
    font-size: 0.7rem;
    color: #95a5a6;
}

.showing-info {
    font-size: 0.9rem;
    color: #7f8c8d;
}

@media (max-width: 768px) {
    .admin-metric-card {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
    }
    
    .user-info {
        flex-direction: column;
        text-align: center;
        gap: 0.5rem;
    }
    
    .admin-actions {
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .log-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .log-timestamp {
        min-width: auto;
    }
}
</style>
{% endblock %}
